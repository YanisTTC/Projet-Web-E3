<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <title>Station essence en Seine et Marne</title>
  <link rel="icon" href="data:,">

  <!--Lien CSS de Leaflet (toujours avant le lien JS)-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  
  <style>
    #map { width: 600px; height: 600px; }
  </style>

  <!--Lien JS Leaflet (toujours après le lien CSS)-->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  
  <script>
    "use strict";

    async function getPrixCarburants() {

      let rep = await fetch("/prix-des-carburants-en-france-flux-instantane-v2.geojson")
  
      if (!rep.ok) {
        throw Error(rep.statusText);
      }
      console.log(rep.status);

      let json = await rep.json();
      console.log(json);

      return json;

    }
    
    window.onload = async () => {
      /*Crée un layer avec les tuiles OpenStreetMap*/
      let layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.{ext}', {
        maxZoom: 15,
        attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        ext: 'png'
      });

      /*Crée une map affichée dans le layer précédent, avec un zoom de 9 sur les coordonnées spécifiées*/
      let map = L.map('map', {
          center: [48.6686111, 2.843888888888889],
          zoom: 9,
          layers: [layer]
      });

      /*Crée un marqueur sur les coordonnées spécifiées*/
      let marker = L.marker([48.6266667, 2.9333333333333336],{title: 'Centre Géographique de Seine-et-Marne'}).addTo(map);
      /*Coordonnées du centre géographique de Seine et Marne (IGN Institut)*/

      let data = await getPrixCarburants();
      
      function createCustomIcon (feature, latlng) {
        let myIcon = L.icon({
          iconUrl: 'essence_icon.png',
          shadowUrl: 'essence_icon.png',
          iconSize:     [35, 35], // width and height of the image in pixels
          shadowSize:   [35, 20], // width, height of optional shadow image
          iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
          shadowAnchor: [12, 6],  // anchor point of the shadow. should be offset
          popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        })
        return L.marker(latlng, { icon: myIcon , title: "E10: " + feature.properties.e10_prix + "€"})
      }

      function createCustomFilter(feature) {
          return feature.properties.e10_prix > 1.8 && feature.properties.id != 77140010 && feature.properties.id != 77140012;
      }

      let myLayerOptions = {
        pointToLayer: createCustomIcon,
        filter: createCustomFilter
      }

      let carburants = L.geoJSON(data,myLayerOptions).addTo(map);

    }; 
  </script>

</head>

<body>

  <div id="map"></div>

</body>
</html>
