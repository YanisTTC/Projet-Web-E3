<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stud’Path - Find student residences and universities with ease">
    <meta name="author" content="Your Name">
    <title>Stud'Path</title>

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="assets/styles.css">
    
    <!-- Leaflet.js (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!--Link JS Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <script>
        "use strict";

        async function fetchSchool() {

            let response = await fetch("/fr-esr-principaux-etablissements-enseignement-superieur@mesr.geojson")
        
            if (!response.ok) {
                throw Error(response.statusText);
            }
            console.log(response.status);

            let json = await response.json();
            console.log(json);

            return json;

        }

        
        /*****************     Student Housing     *****************/

        async function fetchHousing() {

            let response = await fetch("/fr_crous_logement_france_entiere@mesr.geojson")

            if (!response.ok) {
                throw Error(response.statusText);
            }
            console.log(response.status);

            let json = await response.json();
            console.log(json);

            return json;

        }

        let housingMarkers = [];                                // Store all housing markers for filtering

        // Create custom marker with icon
        function createCustomHousingIcon(feature, latlng) {
            let myIcon = L.icon({
                iconUrl: 'assets/marker_housing.png',
                shadowUrl: 'assets/marker_housing.png',
                iconSize: [35, 35],
                shadowSize: [35, 20],
                iconAnchor: [12, 12],
                shadowAnchor: [12, 6],
                popupAnchor: [0, 0]
            });
            return L.marker(latlng, { icon: myIcon, title: feature.properties.title });
        }

        // Create housing markers and apply filters
        function createHousingMarkers(dataHousing, map) {
            console.log("Applying filters and creating markers...");

            // Clear existing markers
            housingMarkers.forEach(marker => map.removeLayer(marker));
            housingMarkers = [];

            // Get selected filters
            const selectedFilters = Array.from(document.querySelectorAll(".service-filter:checked"))
                .map(input => input.value.toLowerCase());
            console.log("Selected filters:", selectedFilters);

            // Loop through housing data
            dataHousing.features.forEach(feature => {
                const { geometry, properties } = feature;

                if (geometry && geometry.coordinates && properties.services) {
                    const services = properties.services.toLowerCase();

                    // Check if the housing matches all selected filters
                    const matchesFilters = selectedFilters.every(filter => services.includes(filter));

                    if (matchesFilters || selectedFilters.length === 0) {
                        const [lng, lat] = geometry.coordinates;

                        // Create marker with custom icon
                        const marker = createCustomHousingIcon(feature, [lat, lng])
                            .bindPopup(`<h3>${properties.title}</h3><p>${properties.services}</p>`)
                            .addTo(map);

                        housingMarkers.push(marker); // Add marker to array for future management
                    }
                }
            });

            console.log("Markers created:", housingMarkers.length);
        }

        // Apply filters on checkbox change
        function applyFilters(dataHousing, map) {
            console.log("Applying filters...");
            createHousingMarkers(dataHousing, map);
        }
                
        
        /*****************     Geocode a custom address     *****************/
        
        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to fetch geocoding data");
                }
                const data = await response.json();
                if (data.length > 0) {
                    const { lat, lon } = data[0];
                    return { lat: parseFloat(lat), lon: parseFloat(lon) };
                } else {
                    alert("Address not found. Please try again.");
                    return null;
                }
            } catch (error) {
                console.error("Error in geocoding:", error);
                alert("An error occurred while searching for the address.");
                return null;
            }
        }

        
        /*****************     Calculate distances using OpenRouteService API     *****************/
        
        async function calculateMatrixDistances(locations) {
            const apiKey = "5b3ce3597851110001cf6248dbb2adb9062a4c6495d18767be27a734";
            const url = "https://api.openrouteservice.org/v2/matrix/driving-car";

            const body = {
                locations: locations,
                metrics: ["distance"], // You can also use "duration" if needed
                units: "m"
            };

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                        "Authorization": apiKey
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status ${response.status}`);
                }

                const data = await response.json();
                console.log("Matrix Response:", data);
                return data;
            } catch (error) {
                console.error("Error fetching Matrix API:", error);
                alert("Failed to calculate distances. Please try again.");
                return null;
            }
        }

        // Process and display matrix results
        function processMatrixResults(matrix, locations) {
            const distances = matrix.distances;

            distances.forEach((row, i) => {
                row.forEach((distance, j) => {
                    if (i !== j) {
                        console.log(`Distance from location ${i} to ${j}: ${distance} meters`);
                    }
                });
            });
        }

        // Display distances on the map
        function displayDistancesOnMap(matrix, map, locations) {
            const distances = matrix.distances;

            distances.forEach((row, i) => {
                row.forEach((distance, j) => {
                    if (i !== j) {
                        const start = locations[i];
                        const end = locations[j];

                        const polyline = L.polyline([start, end], { color: 'blue' });
                        polyline.addTo(map);
                    }
                });
            });
}


        
        window.onload = async () => {
            /*Create a layer with OpenStreetMap tiles */
            let layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.{ext}', {
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            /*Create a map in the previous layer, with a zoom of 9 on the specific coordinates*/
            let map = L.map('map', {
                center: [48.866667, 2.333333],
                zoom: 7,
                layers: [layer]
            });

            let dataSchool = await fetchSchool();
            let dataHousing = await fetchHousing();

            const searchType = document.getElementById("search-type");
            const searchInput = document.getElementById("search-input");
            const form = document.getElementById("search-form");
            const suggestions = document.getElementById("suggestions");
            //const locations = prepareLocations(dataSchool, dataHousing);
            //const distanceMatrix = await calculateDistances(locations);

            
            let schoolData = dataSchool.features.map(feature => feature.properties.uo_lib);
            let housingData = dataHousing.features.map(feature => feature.properties.title);

            // suggestions handling according to the input
            searchInput.addEventListener("input", () => {
                const value = searchInput.value.toLowerCase();
                suggestions.innerHTML = ""; // Reset suggestions

                if (value.length > 0) {
                    let filteredResults = [];
                    if (searchType.value === "school") {
                        filteredResults = schoolData.filter(school => school.toLowerCase().startsWith(value));
                    } else if (searchType.value === "residence") {
                        filteredResults = housingData.filter(residence => residence.toLowerCase().startsWith(value));
                    }

                    // 5 suggestions max
                    filteredResults.slice(0, 5).forEach(result => {
                        const suggestionItem = document.createElement("li");
                        suggestionItem.textContent = result;
                        suggestionItem.classList.add("suggestion-item");
                        suggestionItem.addEventListener("click", () => {
                            searchInput.value = result; // Fill the input with  the chosen suggestion
                            suggestions.style.display = "none"; // Hide suggestions
                        });
                        suggestions.appendChild(suggestionItem);
                    });

                    // Display or hide suggestions to suit the results
                    suggestions.style.display = filteredResults.length > 0 ? "block" : "none";
                } else {
                    suggestions.style.display = "none"; // Hide if no results
                }
            });


        // Handle the search type
        searchType.addEventListener("change", () => {
            searchInput.value = ""; // Reset the input
            suggestions.innerHTML = ""; // Erase suggestions
            suggestions.style.display = "none"; // Hide suggestions

            const placeholder = {
                residence: "Enter the name of the residence...",
                address: "Enter a custom address...",
                school: "Enter the name of the school..."
            };
            searchInput.placeholder = placeholder[searchType.value];
        });

        // Handle the submission of the form 
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const searchValue = searchInput.value;

            if (searchType.value === "school") {
                const matchedSchool = dataSchool.features.find(
                    feature => feature.properties.uo_lib.toLowerCase() === searchValue.toLowerCase()
                );
                if (matchedSchool) {
                    const { geometry } = matchedSchool;
                    if (geometry && geometry.coordinates) {
                        const [lng, lat] = geometry.coordinates;
                        map.setView([lat, lng], 13); // zoom on the school
                    } else {
                        alert("Coordinates not available for the selected school.");
                    }
                } else {
                    alert("No matching school found.");
                }
            } else if (searchType.value === "residence") {
                const matchedResidence = dataHousing.features.find(
                    feature => feature.properties.title.toLowerCase() === searchValue.toLowerCase()
                );
                if (matchedResidence) {
                    const { geometry } = matchedResidence;
                    if (geometry && geometry.coordinates) {
                        const [lng, lat] = geometry.coordinates;
                        map.setView([lat, lng], 13); // zoom on the residence
                    } else {
                        alert("Coordinates not available for the selected residence.");
                    }
                } else {
                    alert("No matching residence found.");
                }
            } else if (searchType.value === "address") {
                //Call the address geocoding function
                const coordinates = await geocodeAddress(searchValue);
                if (coordinates) {
                    const { lat, lon } = coordinates;

                    // Center the map on the location
                    map.setView([lat, lon], 17);

                    // Add a marker to the location
                    let newMarker = L.marker([lat, lon], {
                        icon: customIcon, // Uses the icon for the click markers
                        title: searchValue,
                    }).addTo(map);

                    // Add the new marker to the list of markers
                    markers.push(newMarker);

                    // Add an event to remove the marker on click
                    newMarker.on("click", function () {
                        map.removeLayer(newMarker);
                        markers = markers.filter((marker) => marker !== newMarker);
                    });
                }
            }
        });

        // Hide suggestions the field loses the focus
        searchInput.addEventListener("blur", () => {
            setTimeout(() => suggestions.style.display = "none", 200); // Délai pour permettre le clic sur une suggestion
        });

        // Display suggestions when the field gains the focus
        searchInput.addEventListener("focus", () => {
            if (suggestions.children.length > 0) {
                suggestions.style.display = "block";
            }
        });
        
        /*****************     Schools     *****************/
        
        function createCustomSchoolIcon (feature, latlng) {
            let myIcon = L.icon({
            iconUrl: 'assets/ecole-icon.png',
            shadowUrl: 'assets/ecole-icon.png',
            iconSize:     [35, 35], // width and height of the image in pixels
            shadowSize:   [35, 20], // width, height of optional shadow image
            iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
            shadowAnchor: [12, 6],  // anchor point of the shadow. should be offset
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
            })
            return L.marker(latlng, { icon: myIcon , title: feature.properties.uo_lib})
        }

        
        /*****************     Student Housing     *****************/
        
        if (dataHousing) {
            // Initial rendering of markers
            createHousingMarkers(dataHousing, map);

            // Listen for filter changes
            document.querySelectorAll(".service-filter").forEach(checkbox => {
                checkbox.addEventListener("change", () => applyFilters(dataHousing, map));
            });
        }
        
        let myLayerSchoolOptions = {
            pointToLayer: createCustomSchoolIcon
        }

        // let myLayerHousingOptions = {
        //     pointToLayer: createCustomHousingIcon
        // }
    
        

        let schools = L.geoJSON(dataSchool,myLayerSchoolOptions).addTo(map);
        //let housing = L.geoJSON(dataHousing,myLayerHousingOptions).addTo(map);

        
        
        /*****************     Add markers to the map by clicking     *****************/
        
        // Initialize an array to keep track of all markers
        let markers = [];

        // Define a custom icon for the markers
        const customIcon = L.icon({
            iconUrl: 'assets/marker_click.png', // URL of the custom icon image
            iconSize: [35, 35], // Size of the icon [width, height]
            iconAnchor: [12, 12], // Anchor point of the icon [horizontal, vertical]
        });

        map.on('click', (event) => {
            // Retrieve the latitude and longitude from the click event
            let { lat, lng } = event.latlng;

            // Create and add a marker at the clicked location with the custom icon
            let newMarker = L.marker([lat, lng], { 
                icon: customIcon, // Use the custom icon here
                title: `Lat: ${lat}, Lng: ${lng}` 
            }).addTo(map);

            // Add the new marker to the markers array
            markers.push(newMarker);
            
            // Add click event to the marker to remove it on the second click
            newMarker.on('click', function () {
                map.removeLayer(newMarker); // Remove marker from the map
                markers = markers.filter(marker => marker !== newMarker); // Remove the marker from the array
            });
        
        });

        /*****************     Remove all markers by clicking on a button    *****************/

        function removeAllMarkers() {
            markers.forEach(marker => map.removeLayer(marker)); // Remove each marker from the map
            markers = []; // Clear the markers array
        }

        // Add a button to remove all markers
        let button = L.control({ position: 'topright' });
        button.onAdd = function () {
            let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.padding = '5px';
            div.style.cursor = 'pointer';
            div.innerHTML = 'Remove All Markers';
            div.onclick = removeAllMarkers; // Attach the removeAllMarkers function to the button click
            return div;
        };

        button.onAdd = function () {
            let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.padding = '5px';
            div.style.cursor = 'pointer';
            div.innerHTML = 'Remove All Markers';

            // Prevent map click events when interacting with the button
            L.DomEvent.on(div, 'click', function (e) {
                L.DomEvent.stopPropagation(e); // Stop click propagation
                removeAllMarkers(); // Call the function to remove all markers
            });

            return div;
        };

        button.addTo(map);

        }; 
    </script>

</head>
<body>
    <!-- Header Section -->
    <header>
        <nav>
            <h1>Stud’Path</h1>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Search Form -->
        <section class="search-section">
            <h2>Find Your Path</h2>
            <form id="search-form">
                <label for="search-type">Search by :</label>
                <select id="search-type" name="search-type">
                    <option value="school">School</option>
                    <option value="residence">Student Residence</option>
                    <option value="address">Custom Address</option>
                </select>
                <input type="text" id="search-input" placeholder="Enter your search term..." autocomplete="off" />
                <!-- suggestions -->
                <ul id="suggestions" style="position: absolute; z-index: 1000;"></ul>
                <button type="submit">Search</button>
            </form>         
        </section>

        <!-- Filters for the Student Housing -->
        <section class="filter-section">
            <div id="filter-student">
                <h3>Filter by Services</h3>
                <label><input type="checkbox" value="Wifi" class="service-filter"> Wifi/Internet</label>
                <label><input type="checkbox" value="Parking" class="service-filter"> Parking</label>
                <label><input type="checkbox" value="laverie" class="service-filter"> Laverie</label>
                <label><input type="checkbox" value="sport" class="service-filter"> Sport</label>
                <label><input type="checkbox" value="handicap" class="service-filter"> Handicap</label>
                <label><input type="checkbox" value="restauration" class="service-filter"> Restauration</label>
            </div>
        </section>
        

        <!-- Map Section -->
        <section id="map-section">
            <div id="map"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Stud’Path </p>
    </footer>

</body>
</html>
