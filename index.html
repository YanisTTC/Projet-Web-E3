<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stud’Path - Find student residences and universities with ease">
    <meta name="author" content="Your Name">
    <title>Stud'Path</title>

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="assets/styles.css">
    <link rel="stylesheet" href="assets/css/map.css">

    <!-- Leaflet.js (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
    <style>
        #map { width: 90%; height: 600px; }
    </style>

    <!--Lien JS Leaflet (toujours après le lien CSS)-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <script>
        "use strict";

        async function fetchSchool() {

            let rep = await fetch("/fr-esr-principaux-etablissements-enseignement-superieur@mesr.geojson")
        
            if (!rep.ok) {
                throw Error(rep.statusText);
            }
            console.log(rep.status);

            let json = await rep.json();
            console.log(json);

            return json;

        }

        async function fetchHousing() {

            let rep = await fetch("/fr_crous_logement_france_entiere@mesr.geojson")

            if (!rep.ok) {
                throw Error(rep.statusText);
            }
            console.log(rep.status);

            let json = await rep.json();
            console.log(json);

            return json;

        }
        
        window.onload = async () => {
            /*Crée un layer avec les tuiles OpenStreetMap*/
            let layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.{ext}', {
                maxZoom: 20,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            /*Crée une map affichée dans le layer précédent, avec un zoom de 9 sur les coordonnées spécifiées*/
            let map = L.map('map', {
                center: [48.866667, 2.333333],
                zoom: 9,
                layers: [layer]
            });

            let dataSchool = await fetchSchool();
            let dataHousing = await fetchHousing();

            const searchType = document.getElementById("search-type");
            const searchInput = document.getElementById("search-input");
            const form = document.getElementById("search-form");
            const suggestions = document.getElementById("suggestions");

            let schoolData = dataSchool.features.map(feature => feature.properties.uo_lib);
            let housingData = dataHousing.features.map(feature => feature.properties.title);

            // Gestion des suggestions en fonction de l'entrée
            searchInput.addEventListener("input", () => {
                const value = searchInput.value.toLowerCase();
                suggestions.innerHTML = ""; // Réinitialiser les suggestions

                if (value.length > 0) {
                    let filteredResults = [];
                    if (searchType.value === "school") {
                        filteredResults = schoolData.filter(school => school.toLowerCase().startsWith(value));
                    } else if (searchType.value === "residence") {
                        filteredResults = housingData.filter(residence => residence.toLowerCase().startsWith(value));
                    }

                    // 5 suggestions maximum
                    filteredResults.slice(0, 5).forEach(result => {
                        const suggestionItem = document.createElement("li");
                        suggestionItem.textContent = result;
                        suggestionItem.classList.add("suggestion-item");
                        suggestionItem.addEventListener("click", () => {
                            searchInput.value = result; // Remplir l'input avec la suggestion choisie
                            suggestions.style.display = "none"; // Cacher les suggestions
                        });
                        suggestions.appendChild(suggestionItem);
                    });

                    // Afficher ou cacher les suggestions en fonction des résultats
                    suggestions.style.display = filteredResults.length > 0 ? "block" : "none";
                } else {
                    suggestions.style.display = "none"; // Cacher si aucun résultat
                }
            });


        // Gérer le type de recherche
        searchType.addEventListener("change", () => {
            searchInput.value = ""; // Réinitialiser l'input
            suggestions.innerHTML = ""; // Effacer les suggestions
            suggestions.style.display = "none"; // Cacher les suggestions

            const placeholder = {
                residence: "Enter the name of the residence...",
                address: "Enter a custom address...",
                school: "Enter the name of the school..."
            };
            searchInput.placeholder = placeholder[searchType.value];
        });

        // Gérer la soumission du formulaire
        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const searchValue = searchInput.value;

            if (searchType.value === "school") {
                const matchedSchool = dataSchool.features.find(
                    feature => feature.properties.uo_lib.toLowerCase() === searchValue.toLowerCase()
                );
                if (matchedSchool) {
                    const { geometry } = matchedSchool;
                    if (geometry && geometry.coordinates) {
                        const [lng, lat] = geometry.coordinates;
                        map.setView([lat, lng], 13); // zoom on the school
                    } else {
                        alert("Coordinates not available for the selected school.");
                    }
                } else {
                    alert("No matching school found.");
                }
            } else if (searchType.value === "residence") {
                const matchedResidence = dataHousing.features.find(
                    feature => feature.properties.title.toLowerCase() === searchValue.toLowerCase()
                );
                if (matchedResidence) {
                    const { geometry } = matchedResidence;
                    if (geometry && geometry.coordinates) {
                        const [lng, lat] = geometry.coordinates;
                        map.setView([lat, lng], 13); // zoom on the residence
                    } else {
                        alert("Coordinates not available for the selected residence.");
                    }
                } else {
                    alert("No matching residence found.");
                }
            } else if (searchType.value === "address") {
                console.log("Searching address:", searchValue);
            }
        });

        // Cacher les suggestions lorsque le champ perd le focus
        searchInput.addEventListener("blur", () => {
            setTimeout(() => suggestions.style.display = "none", 200); // Délai pour permettre le clic sur une suggestion
        });

        // Afficher les suggestions lorsque le champ regagne le focus
        searchInput.addEventListener("focus", () => {
            if (suggestions.children.length > 0) {
                suggestions.style.display = "block";
            }
        });
        
        function createCustomSchoolIcon (feature, latlng) {
            let myIcon = L.icon({
            iconUrl: 'assets/ecole-icon.png',
            shadowUrl: 'assets/ecole-icon.png',
            iconSize:     [35, 35], // width and height of the image in pixels
            shadowSize:   [35, 20], // width, height of optional shadow image
            iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
            shadowAnchor: [12, 6],  // anchor point of the shadow. should be offset
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
            })
            return L.marker(latlng, { icon: myIcon , title: feature.properties.uo_lib})
        }

        function createCustomHousingIcon (feature, latlng) {
            let myIcon = L.icon({
            iconUrl: 'assets/logement-icon.png',
            shadowUrl: 'assets/logement-icon.png',
            iconSize:     [35, 35], // width and height of the image in pixels
            shadowSize:   [35, 20], // width, height of optional shadow image
            iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
            shadowAnchor: [12, 6],  // anchor point of the shadow. should be offset
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
            })
            return L.marker(latlng, { icon: myIcon , title: feature.properties.title})
        }

        /*
        function createCustomFilter(feature) {
            return feature.properties.e10_prix > 1.8 && feature.properties.id != 77140010 && feature.properties.id != 77140012;
        }*/

        
        let myLayerSchoolOptions = {
            pointToLayer: createCustomSchoolIcon
        }

        let myLayerHousingOptions = {
            pointToLayer: createCustomHousingIcon
        }
    
        

        let schools = L.geoJSON(dataSchool,myLayerSchoolOptions).addTo(map);
        let housing = L.geoJSON(dataHousing,myLayerHousingOptions).addTo(map);

        
        
        /*****************     Add markers to the map by clicking     *****************/
        
        // Initialize an array to keep track of all markers
        let markers = [];

        // Define a custom icon for the markers
        const customIcon = L.icon({
            iconUrl: 'assets/marker_click.png', // URL of the custom icon image
            iconSize: [35, 35], // Size of the icon [width, height]
            iconAnchor: [12, 12], // Anchor point of the icon [horizontal, vertical]
        });

        map.on('click', (event) => {
            // Retrieve the latitude and longitude from the click event
            let { lat, lng } = event.latlng;

            // Create and add a marker at the clicked location with the custom icon
            let newMarker = L.marker([lat, lng], { 
                icon: customIcon, // Use the custom icon here
                title: `Lat: ${lat}, Lng: ${lng}` 
            }).addTo(map);

            // Add the new marker to the markers array
            markers.push(newMarker);
            
            // Add click event to the marker to remove it on the second click
            newMarker.on('click', function () {
                map.removeLayer(newMarker); // Remove marker from the map
                markers = markers.filter(marker => marker !== newMarker); // Remove the marker from the array
            });
        
        });

        /*****************     Remove all markers by clicking on a button    *****************/

        function removeAllMarkers() {
            markers.forEach(marker => map.removeLayer(marker)); // Remove each marker from the map
            markers = []; // Clear the markers array
        }

        // Add a button to remove all markers
        let button = L.control({ position: 'topright' });
        button.onAdd = function () {
            let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.padding = '5px';
            div.style.cursor = 'pointer';
            div.innerHTML = 'Remove All Markers';
            div.onclick = removeAllMarkers; // Attach the removeAllMarkers function to the button click
            return div;
        };

        button.onAdd = function () {
            let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            div.style.backgroundColor = 'white';
            div.style.padding = '5px';
            div.style.cursor = 'pointer';
            div.innerHTML = 'Remove All Markers';

            // Prevent map click events when interacting with the button
            L.DomEvent.on(div, 'click', function (e) {
                L.DomEvent.stopPropagation(e); // Stop click propagation
                removeAllMarkers(); // Call the function to remove all markers
            });

            return div;
        };

        button.addTo(map);

        }; 
    </script>

</head>
<body>
    <!-- Header Section -->
    <header>
        <nav>
            <h1>Stud’Path</h1>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Search Form -->
        <section class="search-section">
            <h2>Find Your Path</h2>
            <form id="search-form">
                <label for="search-type">Search by :</label>
                <select id="search-type" name="search-type">
                    <option value="school">School</option>
                    <option value="residence">Student Residence</option>
                    <option value="address">Custom Address</option>
                </select>
                <input type="text" id="search-input" placeholder="Enter your search term..." autocomplete="off" />
                <!-- Liste des suggestions générée dynamiquement -->
                <ul id="suggestions" style="position: absolute; z-index: 1000;"></ul>
                <button type="submit">Search</button>
            </form>
        </section>
        

        <!-- Map Section -->
        <section id="map-section">
            <div id="map"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Stud’Path </p>
    </footer>

</body>
</html>
