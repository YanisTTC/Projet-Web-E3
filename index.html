<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stud’Path - Find student residences and universities with ease">
    <meta name="author" content="Your Name">
    <title>Stud'Path</title>

    <!-- CSS Stylesheets -->
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/map.css">

    <!-- Leaflet.js (Map Library) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
    <style>
        #map { width: 600px; height: 600px; }
    </style>

    <!--Lien JS Leaflet (toujours après le lien CSS)-->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    
    <script>
        "use strict";

        async function fetchSchool() {

            let rep = await fetch("/fr-esr-principaux-etablissements-enseignement-superieur@mesr.geojson")

            if (!rep.ok) {
                throw Error(rep.statusText);
            }
            console.log(rep.status);

            let json = await rep.json();
            console.log(json);

            return json;

        }

        async function fetchHousing() {

            let rep = await fetch("/fr_crous_logement_france_entiere@mesr.geojson")

            if (!rep.ok) {
                throw Error(rep.statusText);
            }
            console.log(rep.status);

            let json = await rep.json();
            console.log(json);

            return json;

        }
        
        
        
        /*****************     Create the Popup for each school and student housing     *****************/
        
        function createPopupContent(properties) {
            const photo = properties.photo ? properties.photo.replace(/\\/g, '') : 'assets/images/default.jpg';

            // Dynamically construct content based on the available properties
            const lines = [];

            if (properties.title || properties.name || properties.uo_lib) {
                lines.push(`<strong>${properties.title || properties.name || properties.uo_lib}</strong><br>`);
            }

            if (properties.phone || properties.numero_telephone_uai) {
                lines.push(`<p><strong>Phone:</strong> ${properties.phone || properties.numero_telephone_uai}</p>`);
            }

            if (properties.address || properties.adresse_uai) {
                lines.push(`<p><strong>Address:</strong> ${properties.address || properties.adresse_uai}</p>`);
            }

            if (properties.services) {
                lines.push(`<p><strong>Services:</strong> ${properties.services}</p>`);
            }

            if (properties.mail) {
                lines.push(
                    `<p><strong>Email:</strong> <a href="mailto:${properties.mail}" target="_blank">${properties.mail}</a></p>`
                );
            }

            if (properties.url || properties.interneturl) {
                const website = properties.url || properties.interneturl;
                lines.push(
                    `<p><strong>Web site:</strong> <a href="${website}" target="_blank">${website}</a></p>`
                );
            }

            // Combine all lines into the popup content
            return `
                <div>
                    <img src="${photo}" alt="Photo" style="width: 100%; height: auto; margin-bottom: 10px;" 
                        onerror="this.src='assets/images/default.jpg';">
                    ${lines.join('')}
                </div>
            `;
        }
        /************************************************************************************/

        
        
        /*****************     Create custumized icons for the markers     *****************/
        
        function createCustomIcon(iconUrl) {
            return L.icon({
                iconUrl,
                iconSize: [35, 35],
                iconAnchor: [12, 12],
                popupAnchor: [0, -10]
            });
        }

        /************************************************************************************/
        
        window.onload = async () => {
            /*Crée un layer avec les tuiles OpenStreetMap*/
            let layer = L.tileLayer('https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.{ext}', {
                maxZoom: 25,
                attribution: '&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                ext: 'png'
            });

            /*Crée une map affichée dans le layer précédent, avec un zoom de 9 sur les coordonnées spécifiées*/
            let map = L.map('map', {
                center: [48.6686111, 2.843888888888889],
                zoom: 9,
                layers: [layer]
            });

            
            let dataSchool = await fetchSchool();
            let dataHousing = await fetchHousing();
            
            
            function createSchoolMarker(feature, latlng) {
                let marker = L.marker(latlng, {
                    icon: createCustomIcon('assets/marker_school.png'),
                    title: feature.properties.name
                });
                marker.bindPopup(createPopupContent(feature.properties));
                return marker;
            }


            function createHousingMarker(feature, latlng) {
                let marker = L.marker(latlng, {
                    icon: createCustomIcon('assets/marker_housing.png'),
                    title: feature.properties.name
                });
                marker.bindPopup(createPopupContent(feature.properties));
                return marker;
            }

            /*
            function createCustomFilter(feature) {
                return feature.properties.e10_prix > 1.8 && feature.properties.id != 77140010 && feature.properties.id != 77140012;
            }*/

            
            L.geoJSON(dataSchool, {
                pointToLayer: createSchoolMarker
            }).addTo(map);

            L.geoJSON(dataHousing, {
                pointToLayer: createHousingMarker
            }).addTo(map);
            
            
            /*****************     Add markers to the map by clicking     *****************/
            
            // Initialize an array to keep track of all markers
            let markers = [];

            // Define a custom icon for the markers
            const customIcon = L.icon({
                iconUrl: 'assets/marker_click.png', // URL of the custom icon image
                iconSize: [35, 35], // Size of the icon [width, height]
                iconAnchor: [12, 12], // Anchor point of the icon [horizontal, vertical]
            });

            // Flag to track if a popup is open
            let popupOpen = false; 

            // Listen for when a popup is opened and set the flag
            map.on('popupopen', () => {
                popupOpen = true;
            });

            // Listen for when a popup is closed and reset the flag
            map.on('popupclose', () => {
                popupOpen = false;
            });

            // Map click event to handle marker creation
            map.on('click', (event) => {
                // Do nothing if the popup is open
                if (popupOpen) {
                    return;
                }

                // If the click is not on a marker or popup, create a new marker
                let { lat, lng } = event.latlng;

                let newMarker = L.marker([lat, lng], {
                    icon: customIcon, // Use the custom icon here
                    title: `Lat: ${lat}, Lng: ${lng}`
                }).addTo(map);

                markers.push(newMarker); // Add marker to the array

                // Add click event to the marker to remove it on the second click
                newMarker.on('click', function () {
                    map.removeLayer(newMarker); // Remove marker from map
                    markers = markers.filter(marker => marker !== newMarker); // Remove from array
                });
            });




            /*****************     Remove all markers by clicking on a button    *****************/

            function removeAllMarkers() {
                markers.forEach(marker => map.removeLayer(marker)); // Remove each marker from the map
                markers = []; // Clear the markers array
            }

            // Add a button to remove all markers
            let button = L.control({ position: 'topright' });
            button.onAdd = function () {
                let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.style.backgroundColor = 'white';
                div.style.padding = '5px';
                div.style.cursor = 'pointer';
                div.innerHTML = 'Remove All Markers';
                div.onclick = removeAllMarkers; // Attach the removeAllMarkers function to the button click
                return div;
            };

            button.onAdd = function () {
                let div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.style.backgroundColor = 'white';
                div.style.padding = '5px';
                div.style.cursor = 'pointer';
                div.innerHTML = 'Remove All Markers';

                // Prevent map click events when interacting with the button
                L.DomEvent.on(div, 'click', function (e) {
                    L.DomEvent.stopPropagation(e); // Stop click propagation
                    removeAllMarkers(); // Call the function to remove all markers
                });

                return div;
            };

            button.addTo(map);

        }; 
    </script>

</head>
<body>
    <!-- Header Section -->
    <header>
        <nav>
            <h1>Stud’Path</h1>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Search Form -->
        <section class="search-section">
            <h2>Find Your Path</h2>
            <form id="search-form">
                <label for="search-type">Search by:</label>
                <select id="search-type" name="search-type">
                    <option value="residence">Student Residence</option>
                    <option value="address">Custom Address</option>
                    <option value="school">School</option>
                </select>
                <input type="text" id="search-input" placeholder="Enter your search term..." />
                <button type="submit">Search</button>
            </form>
        </section>

        <!-- Map Section -->
        <section id="map-section">
            <div id="map"></div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Stud’Path. All rights reserved.</p>
    </footer>

    <!-- JavaScript Files -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/map.js"></script>
</body>
</html>
